
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Private Cloud Chat</title>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 600px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .auth-bar { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #007bff; }
        
        /* Стили для списка пользователей */
        .user-list { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .user-card { cursor: pointer; text-align: center; min-width: 70px; font-size: 12px; transition: 0.3s; }
        .user-card:hover { transform: scale(1.1); color: #007bff; }
        .user-card img { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 5px; }

        /* Стили сообщений */
        #chatBox { height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 15px; border-radius: 10px; background: #fafafa; margin-bottom: 15px; display: flex; flex-direction: column; }
        .msg { margin-bottom: 10px; padding: 10px 15px; border-radius: 18px; max-width: 70%; position: relative; }
        .msg.sent { align-self: flex-end; background: #007bff; color: white; border-bottom-right-radius: 2px; }
        .msg.received { align-self: flex-start; background: #e4e6eb; color: #050505; border-bottom-left-radius: 2px; }
        
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        input { width: calc(100% - 100px); padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="authSection" class="container" style="text-align: center;">
        <button id="loginBtn">Войти через Google</button>
        <div id="userInfo" style="display: none;" class="auth-bar">
            <img id="userPhoto" class="user-avatar" src="">
            <div>
                <div id="userName" style="font-weight: bold;"></div>
                <button id="logoutBtn" style="background:none; color:red; padding:0; font-size:12px;">Выйти</button>
            </div>
        </div>
    </div>

    <div id="mainApp" class="container" style="display: none;">
        <p>Выберите собеседника:</p>
        <div id="userList" class="user-list"></div>
        
        <h4 id="chatTitle">Выберите, кому написать...</h4>
        <div id="chatBox"></div>
        
        <div style="display: flex; gap: 10px;">
            <input type="text" id="msgInput" placeholder="Ваше сообщение...">
            <button id="sendBtn">➤</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, query, orderBy, onSnapshot, serverTimestamp, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

       const firebaseConfig = {
  apiKey: "AIzaSyBR_pu5Y7wlqsrScoKOM6qe8nlgD-CxBWE",
  authDomain: "rauan-dee4e.firebaseapp.com",
  projectId: "rauan-dee4e",
  storageBucket: "rauan-dee4e.firebasestorage.app",
  messagingSenderId: "1054739773029",
  appId: "1:1054739773029:web:0d9db0b3a6b0213e6f788c",
  measurementId: "G-MQ3YTKBDGV"
};
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentChatId = null;
        let unsubscribeChat = null;

        // 1. АВТОРИЗАЦИЯ И РЕГИСТРАЦИЯ В БАЗЕ
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('userName').innerText = user.displayName;
                document.getElementById('userPhoto').src = user.photoURL;

                // Сохраняем пользователя в список доступных для чата
                await setDoc(doc(db, "users", user.uid), {
                    name: user.displayName,
                    photo: user.photoURL,
                    lastSeen: serverTimestamp()
                }, { merge: true });

                loadUserList();
            } else {
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('logoutBtn').onclick = () => signOut(auth);

        // 2. ЗАГРУЗКА СПИСКА ЛЮДЕЙ
        async function loadUserList() {
            const usersSnap = await getDocs(collection(db, "users"));
            const listDiv = document.getElementById('userList');
            listDiv.innerHTML = "";
            usersSnap.forEach(uDoc => {
                if (uDoc.id !== auth.currentUser.uid) {
                    const data = uDoc.data();
                    const card = document.createElement('div');
                    card.className = 'user-card';
                    card.innerHTML = `<img src="${data.photo}"><div>${data.name.split(' ')[0]}</div>`;
                    card.onclick = () => openChat(uDoc.id, data.name);
                    listDiv.appendChild(card);
                }
            });
        }

        // 3. ОТКРЫТИЕ ПРИВАТНОГО ЧАТА
        function openChat(targetUid, targetName) {
            document.getElementById('chatTitle').innerText = "Чат с: " + targetName;
            
            // Генерируем ID чата (всегда одинаковый для двоих)
            const myUid = auth.currentUser.uid;
            currentChatId = myUid < targetUid ? `${myUid}_${targetUid}` : `${targetUid}_${myUid}`;

            if (unsubscribeChat) unsubscribeChat();

            const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("timestamp", "asc"));
            unsubscribeChat = onSnapshot(q, (snapshot) => {
                const box = document.getElementById('chatBox');
                box.innerHTML = "";
                snapshot.forEach(mDoc => {
                    const mData = mDoc.data();
                    const side = mData.senderId === myUid ? 'sent' : 'received';
                    box.innerHTML += `<div class="msg ${side}">${mData.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        // 4. ОТПРАВКА
        document.getElementById('sendBtn').onclick = async () => {
            const input = document.getElementById('msgInput');
            if (!input.value || !currentChatId) return;

            await addDoc(collection(db, "chats", currentChatId, "messages"), {
                senderId: auth.currentUser.uid,
                text: input.value,
                timestamp: serverTimestamp()
            });
            input.value = "";
        };

        window.db = db; // Для тестов безопасности в консоли image_332f9f.png
    </script>
</body>
</html>
